<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>Admin – Testimonials</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--fg:#e5e7eb;--primary:#2563eb;--danger:#ef4444;--ok:#10b981}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif}
    header{padding:16px;border-bottom:1px solid #1f2937;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    header input, header select{background:#0b1220;border:1px solid #263043;color:var(--fg);padding:10px 12px;border-radius:10px;min-width:260px}
    header button{background:var(--primary);border:0;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    header .ok{color:var(--ok);font-weight:600}
    main{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px;margin-bottom:16px}
    h2{margin:0 0 12px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{color:var(--muted);text-align:left;font-weight:600;padding:6px 8px}
    td{background:#0b1220;padding:10px;border:1px solid #1f2937}
    td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    input[type="text"], textarea, input[type="number"]{width:100%;background:#0b1220;border:1px solid #253046;color:#fff;padding:8px;border-radius:8px}
    textarea{min-height:70px;resize:vertical}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:8px 10px;border-radius:8px;border:1px solid #263043;background:#0b1220;color:#fff;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary)}
    .btn.danger{background:#3b0c0c;border-color:#4a0f0f;color:#fff}
    .btn.ghost{background:transparent;border-color:#263043}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #263043;background:#0b1220}
    .pill.ok{border-color:#134e4a}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1.2fr 1fr .6fr .4fr .5fr .7fr;gap:8px;align-items:center}
    .grid > div{background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:10px}
    .help{color:#9ca3af;font-size:12px}
  </style>
</head>
<body>
  <header>
    <strong>Testimonials Yönetimi</strong>
    <input id="apiBase" placeholder="API Base (örn: https://api.satinalmacopilot.com)">
    <input id="adminToken" placeholder="Admin Token">
    <button id="saveCfg">Kaydet</button>
    <button id="ping">Ping</button>
    <span id="pingStatus" class="ok" hidden>API OK</span>
  </header>

  <main>
    <div class="card">
      <h2>Yeni Ekle</h2>
      <div class="grid" style="grid-template-columns:1.2fr 1fr 1.6fr .4fr .5fr .6fr">
        <div><input id="newName" type="text" placeholder="Yazar adı"></div>
        <div><input id="newTitle" type="text" placeholder="Unvan / Şirket"></div>
        <div><textarea id="newContent" placeholder="Alıntı"></textarea></div>
        <div><input id="newRating" type="number" min="1" max="5" value="5" title="1-5"></div>
        <div>
          <label class="pill ok"><input id="newActive" type="checkbox" checked> aktif</label>
        </div>
        <div class="row-actions">
          <button class="btn primary" id="addBtn">Ekle</button>
          <span class="help">Sıra, liste sonuna eklenir.</span>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Liste</h2>
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:44px">Sıra</th>
            <th>Yazar</th>
            <th>Unvan</th>
            <th>Metin</th>
            <th style="width:70px">Puan</th>
            <th style="width:90px">Aktif</th>
            <th style="width:220px">İşlemler</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="help">Sıra için ↑↓ düğmelerini kullanın, ardından “Sıraları Kaydet”e basın.</div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn primary" id="saveOrder">Sıraları Kaydet</button>
        <button class="btn ghost" id="reload">Yenile</button>
      </div>
    </div>
  </main>

<script>
const DEFAULT_API_BASE = 'https://api.satinalmacopilot.com';
const LS_KEY = 'admin_cfg_v1';

const $ = sel => document.querySelector(sel);
const state = { rows: [] };

function loadCfg() {
  try { return JSON.parse(localStorage.getItem(LS_KEY)) || {}; } catch { return {}; }
}
function saveCfg(cfg) { localStorage.setItem(LS_KEY, JSON.stringify(cfg)); }

function getApiBase() { return $('#apiBase').value.trim() || DEFAULT_API_BASE; }
function getToken()   { return $('#adminToken').value.trim(); }

async function api(path, opts={}) {
  const url = `${getApiBase()}/api/admin${path}`;
  const token = getToken();
  const headers = { 'Content-Type':'application/json', ...(opts.headers||{}) };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(url, { ...opts, headers });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

function render() {
  const tb = $('#tbody');
  tb.innerHTML = '';
  state.rows.forEach((r, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <div class="row-actions" style="justify-content:center">
          <button class="btn ghost" data-up="${r.id}">↑</button>
          <button class="btn ghost" data-down="${r.id}">↓</button>
          <div class="muted" style="text-align:center">${r.display_order ?? idx}</div>
        </div>
      </td>
      <td><input type="text" value="${esc(r.author_name)}" data-f="author_name" data-id="${r.id}"></td>
      <td><input type="text" value="${esc(r.author_title)}" data-f="author_title" data-id="${r.id}"></td>
      <td><textarea data-f="content" data-id="${r.id}">${esc(r.content)}</textarea></td>
      <td><input type="number" min="1" max="5" value="${Number(r.rating||5)}" data-f="rating" data-id="${r.id}"></td>
      <td style="text-align:center">
        <label class="pill ok">
          <input type="checkbox" ${r.is_active ? 'checked' : ''} data-f="is_active" data-id="${r.id}">
          aktif
        </label>
      </td>
      <td>
        <div class="row-actions">
          <button class="btn primary" data-save="${r.id}">Kaydet</button>
          <button class="btn danger" data-del="${r.id}">Sil</button>
        </div>
      </td>
    `;
    tb.appendChild(tr);
  });
}

function esc(s=''){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

function collectRowValues(id) {
  const sel = `[data-id="${id}"]`;
  const o = {};
  document.querySelectorAll(sel).forEach(el=>{
    const f = el.getAttribute('data-f');
    if (!f) return;
    if (el.type === 'checkbox') o[f] = el.checked;
    else if (el.type === 'number') o[f] = Number(el.value);
    else o[f] = el.value;
  });
  o.updated_at = new Date().toISOString();
  return o;
}

async function loadList() {
  const data = await api('/testimonials', { method:'GET' });
  state.rows = data.testimonials || [];
  // display_order boşsa index verelim
  state.rows.forEach((r,i)=>{ if (r.display_order==null) r.display_order=i; });
  render();
}

async function addNew() {
  const payload = {
    author_name: $('#newName').value.trim(),
    author_title: $('#newTitle').value.trim(),
    content: $('#newContent').value.trim(),
    rating: Number($('#newRating').value || 5),
    is_active: $('#newActive').checked,
    display_order: (state.rows[state.rows.length-1]?.display_order ?? -1) + 1
  };
  if (!payload.author_name || !payload.author_title || !payload.content) {
    alert('Lütfen ad, unvan ve metin alanlarını doldurun.'); return;
  }
  const r = await api('/testimonials', { method:'POST', body: JSON.stringify(payload) });
  state.rows.push(r.testimonial);
  render();
  $('#newName').value=''; $('#newTitle').value=''; $('#newContent').value='';
  $('#newRating').value='5'; $('#newActive').checked=true;
}

async function saveRow(id) {
  const updates = collectRowValues(id);
  const r = await api(`/testimonials/${id}`, { method:'PUT', body: JSON.stringify(updates) });
  const i = state.rows.findIndex(x=>x.id===id);
  if (i>=0) state.rows[i] = r.testimonial;
  render();
}

async function deleteRow(id) {
  if (!confirm('Bu testimonial silinsin mi?')) return;
  await api(`/testimonials/${id}`, { method:'DELETE' });
  state.rows = state.rows.filter(x=>x.id!==id);
  render();
}

function move(id, dir) {
  const i = state.rows.findIndex(x=>x.id===id);
  if (i<0) return;
  const j = dir==='up' ? i-1 : i+1;
  if (j<0 || j>=state.rows.length) return;
  const tmp = state.rows[i];
  state.rows[i] = state.rows[j];
  state.rows[j] = tmp;
  // display_order yeniden ata
  state.rows.forEach((r,idx)=>{ r.display_order = idx; });
  render();
}

async function saveOrder() {
  const payload = state.rows.map(r=>({ id: r.id, display_order: r.display_order ?? 0 }));
  await api('/testimonials/reorder', { method:'PUT', body: JSON.stringify(payload) });
  alert('Sıralar kaydedildi.');
}

async function ping() {
  try {
    const r = await fetch(`${getApiBase()}/api/health`);
    if (!r.ok) throw 0;
    $('#pingStatus').hidden = false;
    setTimeout(()=>$('#pingStatus').hidden=true, 1500);
  } catch { alert('API ulaşılamıyor'); }
}

/* events */
document.addEventListener('click', (e)=>{
  const t = e.target;
  if (t.matches('#addBtn')) addNew();
  else if (t.matches('[data-save]')) saveRow(t.getAttribute('data-save'));
  else if (t.matches('[data-del]')) deleteRow(t.getAttribute('data-del'));
  else if (t.matches('[data-up]'))  move(t.getAttribute('data-up'),'up');
  else if (t.matches('[data-down]'))move(t.getAttribute('data-down'),'down');
  else if (t.matches('#saveOrder')) saveOrder();
  else if (t.matches('#reload')) loadList();
  else if (t.matches('#saveCfg')) { saveCfg({ base: $('#apiBase').value, token: $('#adminToken').value }); alert('Kaydedildi'); }
  else if (t.matches('#ping')) ping();
});

/* bootstrap */
(function init(){
  const cfg = loadCfg();
  $('#apiBase').value = cfg.base || DEFAULT_API_BASE;
  $('#adminToken').value = cfg.token || '';
  loadList().catch(err=>alert('Liste alınamadı: '+err.message));
})();
</script>
</body>
</html>

