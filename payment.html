<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>√ñdeme - Satƒ±nalma CoPilot</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .container{max-width:1200px;width:100%}
    .payment-wrapper{display:grid;grid-template-columns:1fr 1fr;gap:40px;align-items:start}
    .card{background:#fff;border-radius:20px;padding:40px;box-shadow:0 20px 40px rgba(0,0,0,.1)}
    .card-header{text-align:center;margin-bottom:30px}
    .card-title{font-size:2rem;font-weight:700;color:#1e293b;margin-bottom:8px}
    .card-subtitle{color:#64748b;font-size:1.1rem}

    .plan-card{background:linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%);border-radius:12px;padding:24px;margin-bottom:24px;border-left:4px solid #2563eb}
    .plan-name{font-size:1.5rem;font-weight:700;color:#1e293b;margin-bottom:8px}
    .plan-price{font-size:2rem;font-weight:800;color:#2563eb;margin-bottom:8px}
    .features-list{list-style:none;margin-top:16px}
    .features-list li{display:flex;align-items:center;gap:8px;padding:4px 0;color:#475569;font-size:.9rem}

    .selector{display:flex;gap:8px;margin:12px 0 20px}
    .segmented{display:inline-flex;border:1px solid #e2e8f0;border-radius:10px;overflow:hidden}
    .segmented button{padding:10px 14px;border:none;background:#fff;color:#334155;font-weight:600;cursor:pointer}
    .segmented button.active{background:#1d4ed8;color:#fff}
    .pill{border:1px solid #e2e8f0;border-radius:999px;padding:6px 10px;font-size:.8rem;color:#475569}

    .plans-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-bottom:10px}
    .planOption{border:2px solid #e2e8f0;border-radius:12px;padding:14px;cursor:pointer;background:#fff}
    .planOption.active{border-color:#1d4ed8;box-shadow:0 0 0 3px rgba(29,78,216,.12)}
    .planOption h4{margin-bottom:4px;color:#0f172a}
    .planOption p{font-size:.9rem;color:#475569}

    .info-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f1f5f9}
    .info-item:last-child{border-bottom:none}
    .label{color:#64748b;font-weight:500}
    .value{color:#1e293b;font-weight:600}

    .payment-method{border:2px solid #2563eb;background:#f8faff;border-radius:12px;padding:20px;text-align:center;margin-bottom:20px}
    .method-icon{font-size:2rem;margin-bottom:8px}
    .method-name{font-weight:600;color:#1e293b;margin-bottom:4px}

    .summary-section{background:#f8fafc;border-radius:12px;padding:20px;margin-bottom:30px}
    .summary-title{font-weight:600;color:#1e293b;margin-bottom:16px}
    .summary-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #e2e8f0}
    .summary-item:last-child{border-bottom:none;font-weight:600;font-size:1.1rem;color:#1e293b;margin-top:8px;padding-top:16px;border-top:2px solid #e2e8f0}

    .pay-button{width:100%;background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;border:none;padding:16px 24px;border-radius:12px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all .3s ease;margin-bottom:16px}
    .pay-button:hover{background:linear-gradient(135deg,#1d4ed8,#1e40af);transform:translateY(-2px)}
    .pay-button:disabled{background:#94a3b8;cursor:not-allowed;transform:none}

    .security-note{text-align:center;color:#64748b;font-size:.9rem;line-height:1.5}
    .back-link{text-align:center;margin-top:20px}
    .back-link a{color:#2563eb;text-decoration:none;font-weight:500}

    .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
    .loading-content{background:#fff;padding:40px;border-radius:20px;text-align:center}
    .spinner{width:40px;height:40px;border:4px solid #f3f4f6;border-top:4px solid #2563eb;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    .error-message{background:#fee2e2;border:1px solid #f87171;border-radius:8px;padding:20px;margin:20px 0;text-align:center;color:#dc2626}

    @media (max-width:768px){
      .payment-wrapper{grid-template-columns:1fr;gap:20px}
      .card{padding:24px}
      .plans-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="payment-wrapper">
      <!-- Sol: Kullanƒ±cƒ± / Plan kartƒ± -->
      <div class="card">
        <div class="card-header">
          <h1 class="card-title">ü§ñ Satƒ±nalma CoPilot</h1>
          <p class="card-subtitle">Plan Y√ºkseltme & √ñdeme</p>
        </div>

        <!-- Faturalama se√ßici -->
        <div>
          <div class="selector" aria-label="Faturalama sƒ±klƒ±ƒüƒ±">
            <div class="segmented" id="billingToggle">
              <button data-billing="monthly" class="active">Aylƒ±k</button>
              <button data-billing="yearly">Yƒ±llƒ±k <span class="pill" style="margin-left:6px">üü¢ avantajlƒ±</span></button>
            </div>
          </div>

          <!-- Plan kartlarƒ± -->
          <div class="plans-grid" id="planOptions">
            <div class="planOption" data-plan="basic">
              <h4>Basic</h4>
              <p id="p-basic">‚Äî</p>
            </div>
            <div class="planOption active" data-plan="pro">
              <h4>Pro</h4>
              <p id="p-pro">‚Äî</p>
            </div>
            <div class="planOption" data-plan="max">
              <h4>Max</h4>
              <p id="p-max">‚Äî</p>
            </div>
          </div>
        </div>

        <!-- √ñzet kartƒ± -->
        <div class="plan-card" id="planCard">
          <div class="plan-name" id="planName">Plan Y√ºkleniyor...</div>
          <div class="plan-price" id="planPrice">$0.00/ay</div>
          <ul class="features-list" id="planFeatures"></ul>
        </div>

        <div id="userInfo">
          <div class="info-item"><span class="label">Ad Soyad:</span><span class="value" id="userName">Y√ºkleniyor...</span></div>
          <div class="info-item"><span class="label">≈ûirket:</span><span class="value" id="companyName">Y√ºkleniyor...</span></div>
          <div class="info-item"><span class="label">WhatsApp:</span><span class="value" id="phoneNumber">Y√ºkleniyor...</span></div>
          <div class="info-item"><span class="label">Mevcut Plan:</span><span class="value" id="currentPlan">Y√ºkleniyor...</span></div>
        </div>

        <div class="success-message" style="background:#dcfce7;border:1px solid #10b981;border-radius:8px;padding:16px;margin-top:20px;color:#065f46">
          ‚ö° √ñdeme sonrasƒ± WhatsApp asistanƒ±nƒ±z anƒ±nda aktifle≈üir!
        </div>
      </div>

      <!-- Saƒü: √ñdeme kartƒ± -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">G√ºvenli √ñdeme</h2>
          <p class="card-subtitle">Planƒ±nƒ±zƒ± hemen aktifle≈ütirin</p>
        </div>

        <div class="payment-method">
          <div class="method-icon">üí≥</div>
          <div class="method-name">Stripe / Kart √ñdeme</div>
          <div style="font-size:.85rem;color:#64748b;margin-top:8px">Visa, Mastercard - T√ºm kartlar desteklenir</div>
        </div>

        <div class="summary-section">
          <h4 class="summary-title">Sipari≈ü √ñzeti</h4>
          <div class="summary-item"><span>Plan:</span><span id="summaryPlan">Y√ºkleniyor...</span></div>
          <div class="summary-item"><span>S√ºre:</span><span id="summaryDuration">-</span></div>
          <div class="summary-item"><span>Mesaj Kotasƒ±:</span><span id="summaryQuota">-</span></div>
          <div class="summary-item"><span>USD Fiyat:</span><span id="summaryUSD">$0.00</span></div>
        </div>

        <button class="pay-button" id="payButton" disabled>
          <span id="payButtonText">√ñdemeyi Ba≈ülat</span>
        </button>

        <div class="security-note">
          üîí √ñdemeleriniz SSL ile ≈üifrelenir<br>
          üí≥ Abonelik y√∂netimi Stripe Portal‚Äôdan<br>
          üí¨ WhatsApp OTP ile hƒ±zlƒ± giri≈ü
        </div>

        <div class="back-link"><a href="index.html">‚Üê Ana Sayfaya D√∂n</a></div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <h3 id="loadingText">√ñdeme ƒ∞≈üleniyor...</h3>
      <p>L√ºtfen sayfayƒ± kapatmayƒ±n</p>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const API = "https://api.satinalmacopilot.com";

    // JWT guard ‚Äì yoksa login
    (function guard(){
      const tok = localStorage.getItem('sc.jwt');
      if(!tok){ window.location.href = '/login.html'; }
    })();

    // Fiyat & kota ‚Äî Admin‚Äôdeki deƒüerlerle hizalƒ±
    const PRICING = {
      monthly: {
        basic: { price: 19.00,  quota:  500,  name: 'Basic' },
        pro:   { price: 49.00,  quota: 1500,  name: 'Pro'   },
        max:   { price: 99.00,  quota: 5000,  name: 'Max'   }
      },
      yearly: {
        basic: { price: 129.00, quota:  12000,  name: 'Basic' },
        pro:   { price: 449.00, quota:  60000,  name: 'Pro'   },
        max:   { price: 999.00, quota: 180000,  name: 'Max'   }
      }
    };

    const FEATURES = {
      basic: ['‚úÖ Tedarik√ßi Bulma','‚úÖ Basit RFQ','‚úÖ Temel Risk Analizi','‚ùå API Eri≈üimi'],
      pro:   ['‚úÖ T√ºm Basic','‚úÖ Geli≈ümi≈ü RFQ','‚úÖ Detaylƒ± Risk Analizi','‚úÖ API Eri≈üimi'],
      max:   ['‚úÖ T√ºm Pro','‚úÖ √ñncelikli Destek','‚úÖ ERP Entegrasyonu','‚úÖ √ñzel Raporlama']
    };

    // Global state
    let selectedPlan = 'pro';
    let selectedBilling = 'monthly';
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', init);

    async function init(){
      bindUI();
      hydratePrices();
      await loadProfile();     // kullanƒ±cƒ± bilgisi
      updatePlanDisplay();
      updateSummary();
      document.getElementById('payButton').disabled = false;
    }

    function bindUI(){
      // billing toggle
      document.querySelectorAll('#billingToggle button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          selectedBilling = btn.dataset.billing;
          document.querySelectorAll('#billingToggle button').forEach(b=>b.classList.toggle('active', b===btn));
          hydratePrices();
          updatePlanDisplay();
          updateSummary();
        });
      });

      // plan kartlarƒ±
      document.querySelectorAll('.planOption').forEach(card=>{
        card.addEventListener('click', ()=>{
          selectedPlan = card.dataset.plan;
          document.querySelectorAll('.planOption').forEach(c=>c.classList.toggle('active', c===card));
          updatePlanDisplay();
          updateSummary();
        });
      });

      // pay
      document.getElementById('payButton').addEventListener('click', processPayment);
    }

    function hydratePrices(){
      ['basic','pro','max'].forEach(p=>{
        const el = document.getElementById(`p-${p}`);
        const plan = PRICING[selectedBilling][p];
        el.textContent = `${plan.name} ‚Ä¢ ${plan.quota.toLocaleString()} mesaj ‚Ä¢ $${plan.price}`;
      });
    }

    async function loadProfile(){
      const tok = localStorage.getItem('sc.jwt');
      try{
        const r = await fetch(`${API}/api/user/profile`, { headers:{ Authorization: 'Bearer '+tok }});
        const j = await r.json();
        // profil i√ßin phone ve ad e-posta
        const phone = j?.user?.phone || j?.phone || '-';
        currentUser = {
          name: j?.user?.name || j?.name || '-',
          company_name: j?.user?.company || j?.company || '-',
          contact_phone: phone,
          subscription_plan: (j?.user?.subscription_plan || j?.subscription_plan || 'trial')
        };
        // lookup ile kota & durum
        const r2 = await fetch(`${API}/api/customer/lookup`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ phone })
        });
        const u = await r2.json();
        if(u?.exists){
          currentUser.subscription_plan = u.subscription_status === 'trial' ? 'trial' : (u.subscription_plan || 'trial');
        }
        // UI
        document.getElementById('userName').textContent    = currentUser.name || '‚Äî';
        document.getElementById('companyName').textContent = currentUser.company_name || '‚Äî';
        document.getElementById('phoneNumber').textContent = currentUser.contact_phone || '‚Äî';
        document.getElementById('currentPlan').textContent = (currentUser.subscription_plan || 'trial').toUpperCase();
      }catch{
        // profil okunamazsa yine √∂deme akƒ±≈üƒ±nƒ± engellemeyelim
      }
    }

    function updatePlanDisplay() {
      const plan = PRICING[selectedBilling][selectedPlan];
      document.getElementById('planName').textContent  = `${plan.name} Plan`;
      document.getElementById('planPrice').textContent = `$${plan.price}/${selectedBilling==='monthly'?'ay':'yƒ±l'}`;
      document.getElementById('planFeatures').innerHTML =
        FEATURES[selectedPlan].map(x=>`<li>${x}</li>`).join('');
    }

    function updateSummary() {
      const plan = PRICING[selectedBilling][selectedPlan];
      document.getElementById('summaryPlan').textContent     = plan.name;
      document.getElementById('summaryDuration').textContent = selectedBilling==='monthly'?'1 Ay':'1 Yƒ±l';
      document.getElementById('summaryQuota').textContent    = plan.quota.toLocaleString() + ' mesaj';
      document.getElementById('summaryUSD').textContent      = '$' + plan.price.toFixed(2);
      document.getElementById('payButtonText').textContent   = `$${plan.price.toFixed(2)} √ñde`;
    }

    // √ñdeme akƒ±≈üƒ±
    async function processPayment(){
      const tok = localStorage.getItem('sc.jwt');
      if(!tok){ window.location.href='/login.html'; return; }

      showLoading('√ñdeme hazƒ±rlanƒ±yor‚Ä¶');
      try{
        const res = await fetch(`${API}/api/payment/create-checkout-session`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+tok },
          body: JSON.stringify({ plan_code: selectedPlan, billing_cycle: selectedBilling })
        });
        const out = await res.json();

        hideLoading();
        if (out?.url) {
          window.location.href = out.url;
        } else if (out?.checkout_url){
          window.location.href = out.checkout_url;
        } else {
          throw new Error(out?.error || 'No checkout URL');
        }
      }catch(err){
        hideLoading();
        showError(`√ñdeme i≈ülemi ba≈ülatƒ±lamadƒ±: ${err.message}`);
      }
    }

    // UI helpers
    function showLoading(msg){ document.getElementById('loadingText').textContent = msg; document.getElementById('loadingOverlay').style.display='flex'; }
    function hideLoading(){ document.getElementById('loadingOverlay').style.display='none'; }
    function showError(message){
      const div = document.createElement('div');
      div.className='error-message';
      div.innerHTML = `<h3>‚ö†Ô∏è Hata</h3><p>${message}</p>`;
      const firstCard = document.querySelector('.card');
      firstCard.parentNode.insertBefore(div, firstCard.nextSibling);
    }
  </script>
</body>
</html>

