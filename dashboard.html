<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Satƒ±nalmaCoPilot üéØ</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3Eü§ñ%3C/text%3E%3C/svg%3E">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      color: #1e293b;
    }

    /* ========== Header ========== */
    .header {
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .logo-section:hover {
      opacity: 0.8;
    }

    .logo { font-size: 2rem; }

    .brand-text {
      font-size: 1.5rem;
      font-weight: 800;
      color: #2563eb;
    }

    .nav-auth a {
      color: #64748b;
      text-decoration: none;
      font-weight: 600;
      margin-left: 20px;
    }

    .nav-auth a:hover { color: #2563eb; }

    /* ========== Container ========== */
    .container {
      max-width: 1200px;
      margin: 32px auto;
      padding: 0 24px;
    }

    .loading, .error-box {
      background: white;
      border-radius: 16px;
      padding: 60px 40px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ========== Cards ========== */
    .card {
      background: white;
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.2s;
    }

    .card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f1f5f9;
    }

    .card-icon {
      font-size: 2rem;
    }

    .card-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #1e293b;
    }

    /* ========== Usage Card ========== */
    .usage-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-box {
      text-align: center;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      color: white;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 0.95rem;
      opacity: 0.9;
    }

    .progress-container {
      margin-top: 20px;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 0.95rem;
      color: #64748b;
    }

    .progress-bar-bg {
      background: #e2e8f0;
      height: 16px;
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
      border-radius: 999px;
      transition: width 0.5s ease;
    }

    /* ========== Info Grid ========== */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .info-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1e293b;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    /* ========== Status Badge ========== */
    .status-badge {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-paid, .status-active {
      background: #d1fae5;
      color: #065f46;
    }

    .status-trial {
      background: #fef3c7;
      color: #92400e;
    }

    .status-expired {
      background: #fee2e2;
      color: #991b1b;
    }

    /* ========== Action Buttons ========== */
    .action-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 24px;
    }

    .action-btn {
      display: inline-block;
      width: 100%;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 700;
      text-align: center;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(37, 99, 235, 0.3);
    }

    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    .btn-profile {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
    }

    .btn-profile:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(139, 92, 246, 0.3);
    }

    /* ========== Referral Section ========== */
    .referral-input-group {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .referral-input {
      flex: 1;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      color: #2563eb;
      background: #f9fafb;
      text-align: center;
      letter-spacing: 1px;
      font-family: 'Courier New', monospace;
    }

    .referral-copy-btn {
      padding: 14px 24px;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .referral-copy-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .referral-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .referral-stat {
      background: #f8fafc;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
    }

    .referral-stat-number {
      font-size: 1.8rem;
      font-weight: 800;
      color: #2563eb;
      margin-bottom: 4px;
    }

    .referral-stat-label {
      font-size: 0.85rem;
      color: #64748b;
    }

    /* ========== Responsive ========== */
    @media (max-width: 768px) {
      .header {
        padding: 12px 16px;
      }

      .brand-text {
        font-size: 1.2rem;
      }

      .container {
        padding: 0 16px;
      }

      .info-grid {
        grid-template-columns: 1fr;
      }

      .action-grid {
        grid-template-columns: 1fr;
      }

      .usage-stats {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="header">
    <div class="logo-section" onclick="location.href='index.html'">
      <div class="logo">ü§ñ</div>
      <div class="brand-text">Satƒ±nalma CoPilot</div>
    </div>
    <div class="nav-auth">
      <a href="#" onclick="handleLogout(); return false;">√áƒ±kƒ±≈ü</a>
    </div>
  </div>

  <!-- CONTAINER -->
  <div class="container">

    <!-- Loading State -->
    <div class="loading" id="loadingState">
      <div class="spinner"></div>
      <p>Verileriniz y√ºkleniyor...</p>
    </div>

    <!-- Error State -->
    <div class="error-box" id="errorState" style="display: none;">
      <h3 style="color: #dc2626; margin-bottom: 12px;">‚ö†Ô∏è Bir Hata Olu≈ütu</h3>
      <p id="errorMessage" style="color: #64748b;"></p>
      <button onclick="location.reload()" style="margin-top: 16px; padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Tekrar Dene</button>
    </div>

    <!-- Main Content (Hidden by default) -->
    <div id="mainContent" style="display: none;">

      <!-- Usage Stats Card -->
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üìä</span>
          <h2 class="card-title">Kullanƒ±m Durumu</h2>
        </div>

        <div class="usage-stats">
          <div class="stat-box">
            <div class="stat-value" id="totalQuota">0</div>
            <div class="stat-label">Kalan Mesaj Hakkƒ±</div>
          </div>
        </div>

        <div class="progress-container">
          <div class="progress-label">
            <span><strong>Toplam Kota:</strong> <span id="monthlyQuota">0</span> mesaj</span>
            <span><strong>Kullanƒ±lan:</strong> <span id="usedQuota">0</span> mesaj</span>
          </div>
          <div class="progress-bar-bg">
            <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
          </div>
        </div>

        <p style="text-align: center; margin-top: 16px; color: #64748b; font-size: 0.9rem;">
          <strong>PLAN Bƒ∞Tƒ∞≈û TARƒ∞Hƒ∞</strong><br>
          <span id="planEndDate" style="font-weight: 700; color: #1e293b;">14 Kasƒ±m 2025</span>
        </p>
      </div>

      <!-- Account Info Card -->
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üë§</span>
          <h2 class="card-title">Hesap Bilgileri</h2>
        </div>

        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Ad Soyad</span>
            <span class="info-value" id="userName">-</span>
          </div>

          <div class="info-item">
            <span class="info-label">≈ûirket</span>
            <span class="info-value" id="companyName">-</span>
          </div>

          <div class="info-item">
            <span class="info-label">WhatsApp</span>
            <span class="info-value" id="phoneNumber">-</span>
          </div>

          <div class="info-item">
            <span class="info-label">E-posta</span>
            <span class="info-value" id="userEmail">-</span>
          </div>

          <div class="info-item">
            <span class="info-label">Mevcut Plan</span>
            <span class="info-value" id="subscriptionPlan">-</span>
          </div>

          <div class="info-item">
            <span class="info-label">Durum</span>
            <span class="status-badge status-paid" id="subscriptionStatus">AKTƒ∞F</span>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card">
        <div class="card-header">
          <span class="card-icon">‚ö°</span>
          <h2 class="card-title">Hƒ±zlƒ± ƒ∞≈ülemler</h2>
        </div>

        <div class="action-grid">
          <a href="#" class="action-btn btn-primary" onclick="showUpgradeInfo(); return false;">
            üíé Planƒ± Y√ºkselt
          </a>
          <a href="#" class="action-btn btn-secondary" onclick="showCreditInfo(); return false;">
            üí≥ Kredi Y√ºkle
          </a>
          <a href="profile-details.html" class="action-btn btn-profile">
            üìù Detay Bilgilerim
          </a>
        </div>
      </div>

      <!-- Referral Section -->
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üéÅ</span>
          <h2 class="card-title">Arkada≈üƒ±nƒ± Davet Et</h2>
        </div>

        <p style="color: #64748b; margin-bottom: 16px;">
          Arkada≈ülarƒ±nƒ± davet et, hem sen hem de arkada≈üƒ±n <strong>500 mesaj kredisi</strong> kazanƒ±n!
        </p>

        <div class="referral-input-group">
          <input type="text" class="referral-input" id="referralCode" readonly value="LOADING...">
          <button class="referral-copy-btn" onclick="copyReferralCode()">üìã Kopyala</button>
        </div>

        <div class="referral-stats">
          <div class="referral-stat">
            <div class="referral-stat-number" id="referralCount">0</div>
            <div class="referral-stat-label">Ba≈üarƒ±lƒ± Davet</div>
          </div>
          <div class="referral-stat">
            <div class="referral-stat-number" id="referralBonus">0</div>
            <div class="referral-stat-label">Kazanƒ±lan Kredi</div>
          </div>
        </div>
      </div>

    </div>

  </div>

  <script>
    const API_BASE = 'https://api.satinalmacopilot.com';
    const SESSION_KEY = 'copilot_session';
    const SESSION_EXPIRY = 24 * 60 * 60 * 1000; // 24 saat

    // ========== SESSION Y√ñNETƒ∞Mƒ∞ ==========
    
    function saveSession(phone, customerData = {}) {
      const session = {
        phone: phone,
        timestamp: Date.now(),
        customerData: customerData
      };
      localStorage.setItem(SESSION_KEY, JSON.stringify(session));
    }

    function getSession() {
      try {
        const sessionStr = localStorage.getItem(SESSION_KEY);
        if (!sessionStr) return null;
        
        const session = JSON.parse(sessionStr);
        
        // Expiry check
        if (Date.now() - session.timestamp > SESSION_EXPIRY) {
          clearSession();
          return null;
        }
        
        return session;
      } catch (e) {
        console.error('Session parse error:', e);
        return null;
      }
    }

    function clearSession() {
      localStorage.removeItem(SESSION_KEY);
    }

    function getPhoneNumber() {
      // URL'den phone parametresi varsa √∂ncelikli kullan
      const params = new URLSearchParams(window.location.search);
      const urlPhone = params.get('phone');

      if (urlPhone) {
        return urlPhone;
      }

      // localStorage'dan al
      const storedPhone = localStorage.getItem('copilot_phone');
      if (storedPhone) {
        return storedPhone;
      }

      // Session'dan al
      const session = getSession();
      if (session && session.phone) {
        return session.phone;
      }

      return null;
    }

    // Load user dashboard data
    async function loadDashboard() {
      const phone = getPhoneNumber();
      
      if (!phone) {
        showError('Telefon numarasƒ± bulunamadƒ±. L√ºtfen tekrar giri≈ü yapƒ±n.');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/user/profile?phone=${encodeURIComponent(phone)}`);

        if (!response.ok) {
          throw new Error('Veri alƒ±namadƒ±');
        }

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || data.message || 'Bilinmeyen hata');
        }

        const user = data.user;

        // Session'ƒ± g√ºncelle
        saveSession(phone, user);

        // Hide loading, show content
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';

        // Kota bilgilerini g√∂ster
        const monthlyQuota = user.quota?.monthly || 0;
        const usedQuota = user.quota?.used || 0;
        const remainingQuota = user.quota?.remaining || 0;
        const usagePercent = monthlyQuota > 0 ? Math.min(100, (usedQuota / monthlyQuota) * 100) : 0;

        document.getElementById('totalQuota').textContent = remainingQuota.toLocaleString('tr-TR');
        document.getElementById('monthlyQuota').textContent = monthlyQuota.toLocaleString('tr-TR');
        document.getElementById('usedQuota').textContent = usedQuota.toLocaleString('tr-TR');
        document.getElementById('progressBar').style.width = usagePercent + '%';

        // Hesap bilgileri
        document.getElementById('userName').textContent = user.name || '-';
        document.getElementById('companyName').textContent = user.company || '-';
        document.getElementById('phoneNumber').textContent = user.phone || '-';
        document.getElementById('userEmail').textContent = user.email || '-';

        // Plan bilgisi
        const planName = (user.subscription_plan || 'basic').toUpperCase();
        const billingCycle = user.billing_cycle === 'yearly' ? 'Yƒ±llƒ±k' : 'Aylƒ±k';
        document.getElementById('subscriptionPlan').textContent = `${planName} - ${billingCycle}`;

        // Status
        const statusBadge = document.getElementById('subscriptionStatus');
        const status = user.subscription_status || 'trial';

        if (status === 'active' || status === 'paid') {
          statusBadge.textContent = 'AKTƒ∞F';
          statusBadge.className = 'status-badge status-active';
        } else if (status === 'trial') {
          statusBadge.textContent = 'DENEME';
          statusBadge.className = 'status-badge status-trial';
        } else {
          statusBadge.textContent = 'PASIF';
          statusBadge.className = 'status-badge status-expired';
        }

        // Plan end date
        if (user.plan_end_date) {
          const endDate = new Date(user.plan_end_date);
          document.getElementById('planEndDate').textContent = endDate.toLocaleDateString('tr-TR', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
          });
        }

        // Referral code (backend'de yok, bo≈ü bƒ±rak)
        document.getElementById('referralCode').value = 'Yakƒ±nda...';

        // Referral stats
        document.getElementById('referralCount').textContent = '0';
        document.getElementById('referralBonus').textContent = '0';

      } catch (error) {
        console.error('Dashboard load error:', error);
        showError('Veriler y√ºklenirken bir hata olu≈ütu: ' + error.message);
      }
    }

    function showError(message) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('errorState').style.display = 'block';
      document.getElementById('errorMessage').textContent = message;
    }

    function copyReferralCode() {
      const code = document.getElementById('referralCode').value;
      navigator.clipboard.writeText(code).then(() => {
        const btn = document.querySelector('.referral-copy-btn');
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Kopyalandƒ±!';
        btn.style.background = '#10b981';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '';
        }, 2000);
      });
    }

    function showUpgradeInfo() {
      alert('Plan y√ºkseltme i√ßin l√ºtfen bizimle ileti≈üime ge√ßin: info@satinalmacopilot.com');
    }

    function showCreditInfo() {
      alert('Kredi y√ºkleme i√ßin l√ºtfen bizimle ileti≈üime ge√ßin: info@satinalmacopilot.com');
    }

    function handleLogout() {
      if (confirm('√áƒ±kƒ±≈ü yapmak istediƒüinizden emin misiniz?')) {
        clearSession();
        window.location.href = 'index.html';
      }
    }

    // Load dashboard on page load
    window.addEventListener('DOMContentLoaded', loadDashboard);
  </script>

</body>
</html>
